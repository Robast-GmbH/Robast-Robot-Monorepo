name: PlatformIO CI

on: [push]

jobs:
  build:

    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository and submodules
      uses: actions/checkout@v3
    - name: Cache pip
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    - name: Cache PlatformIO
      uses: actions/cache@v3
      with:
        path: ~/.platformio
        key: ${{ runner.os }}-${{ hashFiles('**/lockfiles') }}
    - name: Set up Python
      uses: actions/setup-python@v3
    - name: Install PlatformIO
      run: |
        python -m pip install --upgrade pip
        pip install --upgrade platformio
    - name: Run PlatformIO
      working-directory: src/Hardware/cpp/Drawer_Controller
      run: pio test -e native
    - name: Install g++ compiler
      run: |
        sudo apt install build-essential
    - name: Build Tests
      working-directory: libs/can/tests
      run: |
        g++ -std=c++17 -c tests_main.cpp
        g++ -std=c++17 tests_main.o tests_robast_can_msgs.cpp ../src/* -o test_executable -I .. -Wall -Wextra -Wuseless-cast -Wdouble-promotion -Wnull-dereference -Wpedantic -Wshadow -Wnon-virtual-dtor -Wlogical-op  
    - name: Execute Tests
      working-directory: libs/can/tests
      run: |
        ./test_executable
