<?xml version="1.0" encoding="UTF-8"?>
<root BTCPP_format="4"
      main_tree_to_execute="BehaviorTree">
  <BehaviorTree ID="BehaviorTree">
    <Sequence>
      <ImportEnvironmentLEDColor red="{red}"
                                 green="{green}"
                                 blue="{blue}"
                                 brightness="{brightness}"/>
      <GetBlackboardEntry key="drawer_address"
                          value="{drawer}"/>
      <KeepRunningUntilFailure>
        <IfThenElse>
          <IsRobotChargingCondition target_value="true"
                                    topic="/robot/battery_estimator/data"
                                    battery_level="{battery}"/>
          <Sequence>
            <InitLEDVector size="128"
                           led_vector="{leds}"/>
            <PartialColorizeLED LEDs="{leds}"
                                blue="255"
                                brightness="100"
                                green="0"
                                lower_bound="0.0"
                                red="0"
                                upper_bound="{battery}"
                                LEDs_colored="{leds}"/>
            <PartialColorizeLED LEDs="{leds}"
                                blue="0"
                                brightness="0"
                                green="0"
                                lower_bound="{battery}"
                                red="0"
                                upper_bound="100.0"
                                LEDs_colored="{leds}"/>
            <IfThenElse>
              <LEDChangedCondition led_vector="{leds}"/>
              <LEDPublisherAction drawer_address="{drawer}"
                                  fading_time_ms="100"
                                  led_topic="/led_cmd"
                                  leds="{leds}"/>
              <AlwaysSuccess/>
            </IfThenElse>
          </Sequence>
          <Sequence>
            <InitLEDVector size="128"
                           led_vector="{leds}"/>
            <PartialColorizeLED LEDs="{leds}"
                                blue="{blue}"
                                brightness="{brightness}"
                                green="{green}"
                                lower_bound="0.0"
                                red="{red}"
                                upper_bound="100.0"
                                LEDs_colored="{leds}"/>
            <IfThenElse>
              <BoolTopicCondition target_value="true"
                                  topic="/robot/safety_module/emergency_stop"/>
              <PartialColorizeLED LEDs="{leds}"
                                  blue="0"
                                  brightness="255"
                                  green="0"
                                  lower_bound="0"
                                  red="255"
                                  upper_bound="100"
                                  LEDs_colored="{leds}"/>
              <AlwaysSuccess/>
            </IfThenElse>
            <IfThenElse>
              <BoolTopicCondition target_value="true"
                                  topic="/robot/safety_module/safety_stop"/>
              <PartialColorizeLED LEDs="{leds}"
                                  blue="0"
                                  brightness="100"
                                  green="0"
                                  lower_bound="27.0"
                                  red="255"
                                  upper_bound="50.0"
                                  LEDs_colored="{leds}"/>
              <AlwaysSuccess/>
            </IfThenElse>
            <Sequence>
              <EvaluateDriveDirection path_topic="plan"
                                      prediction_horizon="50"
                                      global_frame="map"
                                      base_frame="robot/base_link"
                                      direction="{direction}"/>
              <Switch4 case_1="standing"
                       case_2="left"
                       case_3="right"
                       case_4="forward"
                       variable="{direction}">
                <AlwaysSuccess/>
                <Sequence>
                  <PartialColorizeLED LEDs="{leds}"
                                      blue="{blue}"
                                      brightness="{brightness}"
                                      green="{green}"
                                      lower_bound="0.0"
                                      red="{red}"
                                      upper_bound="100.0"
                                      LEDs_colored="{leds}"/>
                  <PartialColorizeLED LEDs="{leds}"
                                      blue="0"
                                      brightness="255"
                                      green="80"
                                      lower_bound="48.0"
                                      red="255"
                                      upper_bound="80.0"
                                      LEDs_colored="{leds}"/>
                  <LEDPublisherAction drawer_address="{drawer}"
                                      fading_time_ms="100"
                                      led_topic="/led_cmd"
                                      leds="{leds}"/>
                  <Delay delay_msec="800">
                    <PartialColorizeLED LEDs="{leds}"
                                        blue="{blue}"
                                        brightness="{brightness}"
                                        green="{green}"
                                        lower_bound="0.0"
                                        red="{red}"
                                        upper_bound="100.0"
                                        LEDs_colored="{leds}"/>
                  </Delay>
                  <LEDPublisherAction drawer_address="{drawer}"
                                      fading_time_ms="300"
                                      led_topic="/led_cmd"
                                      leds="{leds}"/>
                  <Delay delay_msec="800">
                    <AlwaysSuccess/>
                  </Delay>
                </Sequence>
                <Sequence>
                  <PartialColorizeLED LEDs="{leds}"
                                      blue="{blue}"
                                      brightness="{brightness}"
                                      green="{green}"
                                      lower_bound="0.0"
                                      red="{red}"
                                      upper_bound="100.0"
                                      LEDs_colored="{leds}"/>
                  <PartialColorizeLED LEDs="{leds}"
                                      blue="0"
                                      brightness="255"
                                      green="80"
                                      lower_bound="0.0"
                                      red="255"
                                      upper_bound="28.0"
                                      LEDs_colored="{leds}"/>
                  <PartialColorizeLED LEDs="{leds}"
                                      blue="0"
                                      brightness="255"
                                      green="80"
                                      lower_bound="95.0"
                                      red="255"
                                      upper_bound="100.0"
                                      LEDs_colored="{leds}"/>
                  <LEDPublisherAction drawer_address="{drawer}"
                                      fading_time_ms="100"
                                      led_topic="/led_cmd"
                                      leds="{leds}"/>
                  <PartialColorizeLED LEDs="{leds}"
                                      blue="{blue}"
                                      brightness="{brightness}"
                                      green="{green}"
                                      lower_bound="0.0"
                                      red="{red}"
                                      upper_bound="100.0"
                                      LEDs_colored="{leds}"/>
                  <Delay delay_msec="800">
                    <LEDPublisherAction drawer_address="{drawer}"
                                        fading_time_ms="300"
                                        led_topic="/led_cmd"
                                        leds="{leds}"/>
                  </Delay>
                  <Delay delay_msec="800">
                    <AlwaysSuccess/>
                  </Delay>
                </Sequence>
                <AlwaysSuccess/>
                <AlwaysSuccess/>
              </Switch4>
            </Sequence>
            <IfThenElse>
              <LEDChangedCondition led_vector="{leds}"/>
              <LEDPublisherAction drawer_address="{drawer}"
                                  fading_time_ms="100"
                                  led_topic="/led_cmd"
                                  leds="{leds}"/>
              <AlwaysSuccess/>
            </IfThenElse>
          </Sequence>
        </IfThenElse>
      </KeepRunningUntilFailure>
    </Sequence>
  </BehaviorTree>

  <!-- Description of Node Models (used by Groot) -->
  <TreeNodesModel>
    <Condition ID="BoolTopicCondition"
               editable="true">
      <input_port name="target_value"
                  default="true">bool</input_port>
      <input_port name="topic"
                  default="/topic_name"/>
    </Condition>
    <Action ID="EvaluateDriveDirection"
            editable="true">
      <input_port name="path_topic"
                  default="path"/>
      <input_port name="prediction_horizon"
                  default="60">nav2 plan steps. approx 5cm per step</input_port>
      <input_port name="global_frame"
                  default="map"/>
      <input_port name="base_frame"
                  default="base_link"/>
      <output_port name="direction"
                   default="standing">standing, left, right, forward</output_port>
    </Action>
    <Action ID="GetBlackboardEntry">
      <input_port name="key"
                  default="drawer_address">string</input_port>
      <output_port name="value"
                   default="{drawer}"/>
    </Action>
    <Action ID="ImportEnvironmentLEDColor"
            editable="true">
      <output_port name="red"
                   default="{red}"/>
      <output_port name="green"
                   default="{green}"/>
      <output_port name="blue"
                   default="{blue}"/>
      <output_port name="brightness"
                   default="{brightness}"/>
    </Action>
    <Action ID="InitLEDVector">
      <input_port name="size"
                  default="128">uint8_t</input_port>
      <output_port name="led_vector"
                   default="{leds}"/>
    </Action>
    <Condition ID="IsRobotChargingCondition"
               editable="true">
      <input_port name="target_value"
                  default="false"/>
      <input_port name="topic"
                  default="/battery_status"/>
      <output_port name="battery_level"
                   default="0.0"/>
    </Condition>
    <Condition ID="LEDChangedCondition"
               editable="true">
      <input_port name="led_vector"
                  default="{leds}"/>
    </Condition>
    <Action ID="LEDPublisherAction">
      <input_port name="drawer_address"
                  default="{drawer}"/>
      <input_port name="fading_time_ms"
                  default="0">uint8</input_port>
      <input_port name="led_topic"
                  default="/drawer_leds"/>
      <input_port name="leds"
                  default="{leds}"/>
    </Action>
    <Action ID="PartialColorizeLED">
      <input_port name="LEDs"
                  default="{leds}"/>
      <input_port name="blue"
                  default="0">uint8</input_port>
      <input_port name="brightness"
                  default="0">uint8 to determine the brightness</input_port>
      <input_port name="green"
                  default="0">uint8</input_port>
      <input_port name="lower_bound"
                  default="0.0">double</input_port>
      <input_port name="red"
                  default="0">uint8</input_port>
      <input_port name="upper_bound"
                  default="0.0">double</input_port>
      <output_port name="LEDs_colored"
                   default="{leds}"/>
    </Action>
  </TreeNodesModel>

</root>
